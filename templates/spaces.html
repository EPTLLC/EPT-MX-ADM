{% extends "base.html" %}

{% block title %}{{ t('spaces.title') }}{% endblock %}

{% block content %}
<div class="fade-in-up">
    <!-- Заголовок страницы с кнопками -->
    <div class="header-section mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 text-gradient mb-0">
                <i class="bi bi-grid-3x3 me-2"></i>{{ t('spaces.title') }}
                {% if spaces_data.total_spaces %}
                <span class="badge bg-primary ms-2">{{ spaces_data.total_spaces }}</span>
                {% endif %}
            </h1>
            <div class="header-actions">
                <button type="button" class="btn btn-outline-primary" onclick="refreshSpaces()">
                    <i class="bi bi-arrow-clockwise me-1"></i>{{ t('dashboard.refresh') }}
                </button>
            </div>
        </div>
        
        <!-- Фильтры и поиск -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-funnel me-2"></i>
                <span>Search & Filters</span>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">{{ t('forms.search') }}</label>
                        <div class="search-box">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" 
                                   class="form-control" 
                                   name="search" 
                                   value="{{ search }}"
                                   placeholder="{{ t('spaces.search_placeholder', default='Search spaces...') }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-1"></i>{{ t('forms.search') }}
                        </button>
                    </div>
                    <div class="col-md-3 text-end">
                        {% if search %}
                        <a href="{{ url_for('spaces.spaces') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>{{ t('forms.clear') }}
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- API Limitation Note -->
        <div class="alert alert-info glass-effect">
            <i class="bi bi-info-circle me-2"></i>
            {{ t('spaces.api_limitation_note', default='Note: Due to Synapse Admin API limitations, some spaces may be shown as regular rooms. For accurate detection, use Matrix Client API.') }}
        </div>
    </div>

    <!-- Список пространств в виде карточек -->
    {% if spaces_data.rooms %}
    <div class="spaces-grid">
        {% for space in spaces_data.rooms %}
        <div class="space-card">
            <div class="space-card-header">
                <div class="space-avatar">
                    {% if space.avatar_url %}
                    <img src="{{ space.avatar_url }}" class="avatar-image" alt="Space Avatar">
                    {% else %}
                    <div class="avatar-circle">
                        <i class="bi bi-grid-3x3-gap-fill"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="space-info">
                    <div class="space-name">{{ space.name or space.canonical_alias or (space.room_id[:20] + '...') }}</div>
                    {% if space.topic %}
                    <div class="space-topic">{{ space.topic[:80] }}{% if space.topic|length > 80 %}...{% endif %}</div>
                    {% endif %}
                    <div class="space-id">{{ space.room_id[:30] }}...</div>
                </div>
                <div class="space-badges">
                    {% if space.public %}
                        <span class="status-badge public">
                            <i class="bi bi-globe"></i>
                            Public
                        </span>
                    {% else %}
                        <span class="status-badge private">
                            <i class="bi bi-lock"></i>
                            Private
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="space-card-body">
                <div class="space-stats">
                    <div class="stat-item">
                        <i class="bi bi-diagram-3"></i>
                        <span class="stat-value">{{ space.children_count or 0 }}</span>
                        <span class="stat-label">Children</span>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-people"></i>
                        <span class="stat-value">{{ space.joined_members or 0 }}</span>
                        <span class="stat-label">Members</span>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-house-heart"></i>
                        <span class="stat-value">{{ space.local_members or 0 }}</span>
                        <span class="stat-label">Local</span>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-tag"></i>
                        <span class="stat-value">v{{ space.room_version or '1' }}</span>
                        <span class="stat-label">Version</span>
                    </div>
                </div>
                
                <div class="space-meta">
                    {% if space.creator and space.creator != 'Unknown' %}
                    <div class="meta-item">
                        <i class="bi bi-person-plus"></i>
                        <span>Created by: <a href="{{ url_for('users.edit_user', user_id=space.creator) }}" class="creator-link">{{ space.creator }}</a></span>
                    </div>
                    {% endif %}
                    {% if space.creation_ts %}
                    <div class="meta-item">
                        <i class="bi bi-calendar-plus"></i>
                        <span>{{ space.creation_ts | datetime_format }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="space-card-actions">
                <button type="button" 
                        class="action-btn primary" 
                        onclick="viewSpace('{{ space.room_id }}')"
                        title="{{ t('spaces.view_space') }}">
                    <i class="bi bi-eye"></i>
                </button>
                <button type="button" 
                        class="action-btn info" 
                        onclick="viewHierarchy('{{ space.room_id }}')"
                        title="{{ t('spaces.hierarchy') }}">
                    <i class="bi bi-diagram-3"></i>
                </button>
                <button type="button" 
                        class="action-btn warning" 
                        onclick="editSpace('{{ space.room_id }}')"
                        title="{{ t('spaces.edit_space') }}">
                    <i class="bi bi-pencil"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="bi bi-grid-3x3-gap-fill"></i>
        </div>
        <h5>{{ t('spaces.no_spaces', default='No spaces found') }}</h5>
        {% if search %}
        <p>{{ t('messages.try_different_search') }}</p>
        <a href="{{ url_for('spaces.spaces') }}" class="btn btn-outline-primary">
            {{ t('forms.show_all') }}
        </a>
        {% else %}
        <p>{{ t('spaces.create_first', default='Create the first space to organize rooms') }}</p>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Пагинация -->
    {% if spaces_data.rooms and (spaces_data.next_token or from_token) %}
    <div class="pagination-section">
        <nav aria-label="Pagination">
            <ul class="pagination justify-content-center">
                {% if from_token %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('spaces', search=search) }}">
                        <i class="bi bi-chevron-left me-1"></i>{{ t('pagination.first') }}
                    </a>
                </li>
                {% endif %}
                
                {% if spaces_data.next_token %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('spaces', search=search, from=spaces_data.next_token) }}">
                        {{ t('pagination.next') }}<i class="bi bi-chevron-right ms-1"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Модальное окно просмотра пространства -->
<div class="modal fade" id="spaceViewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-effect">
            <div class="modal-header">
                <h5 class="modal-title text-gradient">
                    <i class="bi bi-grid-3x3 me-2"></i>{{ t('spaces.view_space') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="spaceViewContent">
                <div class="text-center py-3">
                    <div class="loading"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно иерархии пространства -->
<div class="modal fade" id="hierarchyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content glass-effect">
            <div class="modal-header">
                <h5 class="modal-title text-gradient">
                    <i class="bi bi-diagram-3 me-2"></i>{{ t('spaces.space_hierarchy') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="hierarchyContent">
                <div class="text-center py-3">
                    <div class="loading"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSpaceId = null;

function refreshSpaces() {
    window.location.reload();
}

function viewSpace(spaceId) {
    currentSpaceId = spaceId;
    const modal = new bootstrap.Modal(document.getElementById('spaceViewModal'));
    
    // Показываем модальное окно с загрузкой
    document.getElementById('spaceViewContent').innerHTML = 
        '<div class="text-center py-3"><div class="loading"></div></div>';
    modal.show();
    
    // Загружаем данные пространства
    fetch('/api/spaces/' + spaceId + '/details')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySpaceDetails(data.space);
            } else {
                document.getElementById('spaceViewContent').innerHTML = 
                    '<div class="alert alert-danger">Error: ' + data.error + '</div>';
            }
        })
        .catch(error => {
            document.getElementById('spaceViewContent').innerHTML = 
                '<div class="alert alert-danger">Network error</div>';
        });
}

function displaySpaceDetails(space) {
    const content = 
        '<div class="row">' +
            '<div class="col-md-6">' +
                '<div class="info-card">' +
                    '<h6 class="text-gradient">Space Information</h6>' +
                    '<div class="info-row">' +
                        '<span class="info-label">Name:</span>' +
                        '<span class="info-value">' + (space.name || 'Not specified') + '</span>' +
                    '</div>' +
                    '<div class="info-row">' +
                        '<span class="info-label">Description:</span>' +
                        '<span class="info-value">' + (space.topic || 'Not specified') + '</span>' +
                    '</div>' +
                    '<div class="info-row">' +
                        '<span class="info-label">Space ID:</span>' +
                        '<code class="info-code">' + space.room_id + '</code>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<div class="col-md-6">' +
                '<div class="info-card">' +
                    '<h6 class="text-gradient">Statistics</h6>' +
                    '<div class="info-row">' +
                        '<span class="info-label">Child Rooms:</span>' +
                        '<span class="badge bg-info">' + (space.children ? space.children.length : 0) + '</span>' +
                    '</div>' +
                    '<div class="info-row">' +
                        '<span class="info-label">Created:</span>' +
                        '<span class="info-value">' + (space.creation_ts ? new Date(space.creation_ts).toLocaleString() : 'Unknown') + '</span>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    let finalContent = content;
    
    if (space.children && space.children.length > 0) {
        finalContent += 
            '<hr class="my-4">' +
            '<div class="info-card">' +
                '<h6 class="text-gradient">Child Rooms</h6>' +
                '<div class="children-list">';
        
        space.children.forEach(child => {
            finalContent += 
                '<div class="child-item">' +
                    '<i class="bi bi-house-door me-2"></i>' +
                    '<code>' + child.room_id + '</code>' +
                '</div>';
        });
        
        finalContent += '</div></div>';
    }
    
    document.getElementById('spaceViewContent').innerHTML = finalContent;
}

function viewHierarchy(spaceId) {
    const modal = new bootstrap.Modal(document.getElementById('hierarchyModal'));
    
    // Показываем модальное окно с загрузкой
    document.getElementById('hierarchyContent').innerHTML = 
        '<div class="text-center py-3"><div class="loading"></div></div>';
    modal.show();
    
    // Загружаем иерархию
    fetch('/api/spaces/' + spaceId + '/hierarchy')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayHierarchy(data.hierarchy);
            } else {
                document.getElementById('hierarchyContent').innerHTML = 
                    '<div class="alert alert-danger">Error: ' + data.error + '</div>';
            }
        })
        .catch(error => {
            document.getElementById('hierarchyContent').innerHTML = 
                '<div class="alert alert-danger">Network error</div>';
        });
}

function displayHierarchy(hierarchy) {
    let content = '<div class="hierarchy-tree">';
    
    if (hierarchy.rooms && hierarchy.rooms.length > 0) {
        hierarchy.rooms.forEach(room => {
            const isSpace = room.room_type === 'm.space';
            const icon = isSpace ? 'bi-grid-3x3' : 'bi-house-door';
            const badgeClass = isSpace ? 'bg-info' : 'bg-primary';
            
            content += 
                '<div class="hierarchy-item">' +
                    '<div class="hierarchy-icon">' +
                        '<i class="bi ' + icon + '"></i>' +
                    '</div>' +
                    '<div class="hierarchy-content">' +
                        '<div class="hierarchy-name">' + (room.name || room.canonical_alias || room.room_id) + '</div>' +
                        '<div class="hierarchy-id">' + room.room_id + '</div>' +
                    '</div>' +
                    '<span class="badge ' + badgeClass + '">' + (isSpace ? 'Space' : 'Room') + '</span>' +
                '</div>';
        });
    } else {
        content += '<div class="empty-hierarchy">Empty hierarchy</div>';
    }
    
    content += '</div>';
    
    document.getElementById('hierarchyContent').innerHTML = content;
}

function editSpace(spaceId) {
    // Переход на страницу редактирования
    window.location.href = '/spaces/' + spaceId + '/edit';
}
</script>
{% endblock %} 