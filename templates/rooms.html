{% extends "base.html" %}

{% block title %}{{ t('rooms.title') }}{% endblock %}

{% block content %}
<style>
/* Стили для заголовков таблицы */
.table thead th {
    background: #4e73df !important;
    color: white !important;
    border: none !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    font-size: 0.85rem !important;
    padding: 1rem 0.75rem !important;
    position: sticky !important;
    top: 0 !important;
    z-index: 10 !important;
}

.table thead th:first-child {
    border-top-left-radius: 0.5rem !important;
}

.table thead th:last-child {
    border-top-right-radius: 0.5rem !important;
}

/* Стили для кнопки копирования */
.copy-btn {
    border: none !important;
    background: transparent !important;
    color: #6c757d !important;
    padding: 2px 4px !important;
    border-radius: 3px !important;
    transition: all 0.2s ease !important;
}

.copy-btn:hover {
    background: #e9ecef !important;
    color: #495057 !important;
}

.copy-btn:active {
    transform: scale(0.95) !important;
}
</style>

<div class="container-fluid fade-in-up">
    <!-- Заголовок страницы -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 text-gradient">
                    <i class="bi bi-house-door me-2"></i>
                    {{ t('rooms.title') }}
                </h1>
                <div class="btn-group">
                    <!-- Кнопка фильтров (переключения колонок) -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-funnel me-1"></i>
                            {{ t('rooms.filters') }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="min-width: 250px;">
                            <li><h6 class="dropdown-header">{{ t('rooms.show_columns') }}</h6></li>
                            <li>
                                <div class="dropdown-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showEncryptedCol" checked onchange="toggleColumn('encrypted')">
                                        <label class="form-check-label" for="showEncryptedCol">
                                            <i class="bi bi-shield-lock me-1"></i>
                                            {{ t('rooms.encrypted') }}
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="dropdown-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showMembersCol" checked onchange="toggleColumn('members')">
                                        <label class="form-check-label" for="showMembersCol">
                                            <i class="bi bi-people me-1"></i>
                                            {{ t('rooms.members') }}
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="dropdown-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showLocalMembersCol" checked onchange="toggleColumn('local_members')">
                                        <label class="form-check-label" for="showLocalMembersCol">
                                            <i class="bi bi-house-heart me-1"></i>
                                            {{ t('rooms.local_members') }}
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="dropdown-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showStateEventsCol" checked onchange="toggleColumn('state_events')">
                                        <label class="form-check-label" for="showStateEventsCol">
                                            <i class="bi bi-layers me-1"></i>
                                            {{ t('rooms.state_events') }}
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="dropdown-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showVersionCol" checked onchange="toggleColumn('version')">
                                        <label class="form-check-label" for="showVersionCol">
                                            <i class="bi bi-tag me-1"></i>
                                            {{ t('rooms.room_version') }}
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="dropdown-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showFederatedCol" checked onchange="toggleColumn('federated')">
                                        <label class="form-check-label" for="showFederatedCol">
                                            <i class="bi bi-globe me-1"></i>
                                            {{ t('rooms.federated') }}
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="dropdown-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showInDirectoryCol" checked onchange="toggleColumn('in_directory')">
                                        <label class="form-check-label" for="showInDirectoryCol">
                                            <i class="bi bi-book me-1"></i>
                                            {{ t('rooms.in_directory') }}
                                        </label>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <button type="button" class="btn btn-success" onclick="exportRooms()">
                        <i class="bi bi-download me-1"></i>
                        {{ t('rooms.csv_export') }}
                    </button>
                    <button type="button" class="btn btn-primary" onclick="refreshRooms()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        {{ t('dashboard.refresh') }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Поиск и пагинация -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">{{ t('forms.search') }}</label>
                            <div class="search-box">
                                <i class="bi bi-search search-icon"></i>
                                <input type="text" 
                                       class="form-control" 
                                       id="searchInput"
                                       value="{{ search }}"
                                       placeholder="{{ t('rooms.search_placeholder') }}"
                                       onkeyup="handleSearchKeyup(event)">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">{{ t('pagination.rows_per_page') }}</label>
                            <select class="form-select" onchange="changeLimit(this.value)">
                                <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
                                <option value="25" {% if limit == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                                <option value="500" {% if limit == 500 %}selected{% endif %}>500</option>
                                <option value="1000" {% if limit == 1000 %}selected{% endif %}>1000</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary me-2" onclick="applyFilters()">
                                <i class="bi bi-search me-1"></i>
                                {{ t('forms.search') }}
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>
                                {{ t('forms.clear') }}
                            </button>
                        </div>
                        <div class="col-md-3 text-end">
                            {% if total > 0 %}
                            <small class="text-muted">
                                {{ t('pagination.showing') }} {{ ((current_page - 1) * limit + 1) if total > 0 else 0 }}-{{ [current_page * limit, total] | min }} {{ t('pagination.of') }} {{ total }} {{ t('pagination.entries') }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Список комнат -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        {{ t('rooms.title') }}
                        {% if total %}
                        <span class="badge bg-primary ms-2">{{ total }}</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if rooms_data.rooms %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>{{ t('rooms.room_name') }}</th>
                                    <th>{{ t('rooms.view_action') }}</th>
                                    <th class="col-members">{{ t('rooms.members') }}</th>
                                    <th class="col-local_members">{{ t('rooms.local_members') }}</th>
                                    <th>{{ t('rooms.creator') }}</th>
                                    <th class="col-encrypted">{{ t('rooms.encrypted') }}</th>
                                    <th class="col-federated">{{ t('rooms.federated') }}</th>
                                    <th class="col-version">{{ t('rooms.room_version') }}</th>
                                    <th class="col-state_events">{{ t('rooms.state_events') }}</th>
                                    <th class="col-in_directory">{{ t('rooms.in_directory') }}</th>
                                    <th>{{ t('rooms.created_date') }}</th>
                                    <th>{{ t('rooms.created_time') }}</th>
                                    <th class="text-end">{{ t('rooms.actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for room in rooms_data.rooms %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="room-avatar me-2">
                                                {% if room.avatar_url %}
                                                <img src="{{ room.avatar_url }}" class="rounded-circle" width="32" height="32">
                                                {% else %}
                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="bi bi-house-door text-white"></i>
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-semibold">
                                                    {{ room.name or room.canonical_alias or (room.room_id[:20] + '...') }}
                                                </div>
                                                {% if room.topic %}
                                                <small class="text-muted">{{ room.topic[:50] }}{% if room.topic|length > 50 %}...{% endif %}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" 
                                                class="btn btn-outline-primary" 
                                                onclick="viewRoom('{{ room.room_id }}')"
                                                title="{{ t('rooms.view') }}"
                                                style="padding: 0.5rem 0.75rem;">
                                            <i class="bi bi-eye" style="font-size: 1.65rem;"></i>
                                        </button>
                                    </td>
                                    <td class="col-members">
                                        <span class="badge bg-info">{{ room.joined_members or 0 }}</span>
                                    </td>
                                    <td class="col-local_members">
                                        <span class="badge bg-secondary">{{ room.local_members or 0 }}</span>
                                    </td>
                                    <td>
                                        {% if room.creator and room.creator != 'Unknown' %}
                                        <a href="{{ url_for('users.edit_user', user_id=room.creator) }}" 
                                           class="text-decoration-none">
                                            <small class="text-primary">{{ room.creator }}</small>
                                        </a>
                                        {% else %}
                                        <small class="text-muted">{{ t('messages.unknown') }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="col-encrypted">
                                        {% if room.encrypted %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-shield-lock me-1"></i>
                                            {{ t('forms.yes') }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-shield me-1"></i>
                                            {{ t('forms.no') }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="col-federated">
                                        {% if room.federated %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-globe me-1"></i>
                                            {{ t('forms.yes') }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle me-1"></i>
                                            {{ t('forms.no') }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="col-version">
                                        <span class="badge bg-light text-dark">{{ room.room_version or '1' }}</span>
                                    </td>
                                    <td class="col-state_events">
                                        <span class="badge bg-info">{{ room.state_events or 0 }}</span>
                                    </td>
                                    <td class="col-in_directory">
                                        {% if room.in_directory %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-book me-1"></i>
                                            {{ t('forms.yes') }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-book-fill me-1"></i>
                                            {{ t('forms.no') }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% if room.creation_ts %}
                                                {% set dt = room.creation_ts|datetime_format %}
                                                {{ dt.split(' ')[0] if ' ' in dt else t('messages.unknown') }}
                                            {% else %}
                                                {{ t('messages.unknown') }}
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% if room.creation_ts %}
                                                {% set dt = room.creation_ts|datetime_format %}
                                                {{ dt.split(' ')[1] if ' ' in dt else '' }}
                                            {% else %}
                                                {{ t('messages.unknown') }}
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group">
                                            <button type="button" 
                                                    class="btn btn-outline-warning btn-sm" 
                                                    onclick="editRoom('{{ room.room_id }}')"
                                                    title="{{ t('rooms.edit') }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <div class="btn-group">
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm dropdown-toggle" 
                                                        data-bs-toggle="dropdown">
                                                    <i class="bi bi-gear"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="blockRoom('{{ room.room_id }}')">
                                                            <i class="bi bi-ban me-2"></i>
                                                            {{ t('rooms.block') }}
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <a class="dropdown-item text-danger" href="#" onclick="deleteRoom('{{ room.room_id }}')">
                                                            <i class="bi bi-trash me-2"></i>
                                                            {{ t('rooms.delete') }}
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-house-door-fill text-muted mb-3" style="font-size: 3rem;"></i>
                        <h5 class="text-muted">{{ t('rooms.no_rooms') }}</h5>
                        {% if search %}
                        <p class="text-muted">{{ t('messages.try_different_search') }}</p>
                        <button type="button" class="btn btn-outline-primary" onclick="clearFilters()">
                            {{ t('forms.show_all') }}
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Пагинация -->
    {% if total > limit %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center">
                    <!-- Первая страница -->
                    {% if current_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPage(1)">
                            <i class="bi bi-chevron-double-left me-1"></i>
                            {{ t('pagination.first') }}
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPagePrev()">
                            <i class="bi bi-chevron-left me-1"></i>
                            {{ t('pagination.previous') }}
                        </a>
                    </li>
                    {% endif %}
                    
                    <!-- Номера страниц -->
                    {% set start_page = [1, current_page - 2] | max %}
                    {% set end_page = [total_pages, current_page + 2] | min %}
                    
                    {% if start_page > 1 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    
                    {% for page_num in range(start_page, end_page + 1) %}
                    <li class="page-item {% if page_num == current_page %}active{% endif %}">
                        <a class="page-link" href="#" data-page="{{ page_num }}" onclick="goToPage(this.dataset.page)">{{ page_num }}</a>
                    </li>
                    {% endfor %}
                    
                    {% if end_page < total_pages %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    
                    <!-- Следующая страница -->
                    {% if current_page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPageNext()">
                            {{ t('pagination.next') }}
                            <i class="bi bi-chevron-right ms-1"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPageLast()">
                            {{ t('pagination.last') }}
                            <i class="bi bi-chevron-double-right ms-1"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Подключаем новое детальное модальное окно -->
{% include 'room_details_modal.html' %}


<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{ t('rooms.delete') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>This will completely delete the room and remove all users from it.</strong></p>
                <p class="text-muted">All message history will be deleted and users will be kicked out.</p>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    This action cannot be undone!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {{ t('forms.cancel') }}
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteRoom">
                    <i class="bi bi-trash me-1"></i>
                    {{ t('forms.delete') }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentRoomId = null;
let searchTimeout = null;

// Функции переключения колонок
function toggleColumn(columnType) {
    const columns = document.querySelectorAll('.col-' + columnType);
    const checkbox = document.getElementById('show' + columnType.charAt(0).toUpperCase() + columnType.slice(1) + 'Col');
    
    columns.forEach(col => {
        if (checkbox.checked) {
            col.style.display = '';
        } else {
            col.style.display = 'none';
        }
    });
    
    // Сохраняем состояние в localStorage
    saveColumnState(columnType, checkbox.checked);
}

function saveColumnState(columnType, isVisible) {
    const columnStates = JSON.parse(localStorage.getItem('roomsColumnStates') || '{}');
    columnStates[columnType] = isVisible;
    localStorage.setItem('roomsColumnStates', JSON.stringify(columnStates));
}

function loadColumnStates() {
    const columnStates = JSON.parse(localStorage.getItem('roomsColumnStates') || '{}');
    
    // Применяем сохраненные состояния колонок
    ['encrypted', 'members', 'local_members', 'state_events', 'version', 'federated', 'in_directory'].forEach(columnType => {
        const checkbox = document.getElementById('show' + columnType.charAt(0).toUpperCase() + columnType.slice(1) + 'Col');
        if (checkbox && columnStates.hasOwnProperty(columnType)) {
            checkbox.checked = columnStates[columnType];
            toggleColumn(columnType);
        }
    });
}

function handleSearchKeyup(event) {
    if (event.key === 'Enter') {
        applyFilters();
        return;
    }
    
    // Отложенный поиск
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        applyFilters();
    }, 500);
}

function applyFilters() {
    const url = new URL(window.location);
    const searchValue = document.getElementById('searchInput').value.trim();
    
    if (searchValue) {
        url.searchParams.set('search', searchValue);
    } else {
        url.searchParams.delete('search');
    }
    
    url.searchParams.set('page', '1'); // Сброс на первую страницу
    window.location.href = url.toString();
}

function clearFilters() {
    const url = new URL(window.location.origin + window.location.pathname);
    const currentLimit = new URLSearchParams(window.location.search).get('limit') || '25';
    url.searchParams.set('limit', currentLimit); // Сохраняем limit
    window.location.href = url.toString();
}

function changeLimit(newLimit) {
    const url = new URL(window.location);
    url.searchParams.set('limit', newLimit);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function goToPage(pageNum) {
    const url = new URL(window.location);
    url.searchParams.set('page', pageNum);
    window.location.href = url.toString();
}

function goToPagePrev() {
    const urlParams = new URLSearchParams(window.location.search);
    const currentPage = parseInt(urlParams.get('page')) || 1;
    if (currentPage > 1) {
        goToPage(currentPage - 1);
    }
}

function goToPageNext() {
    const urlParams = new URLSearchParams(window.location.search);
    const currentPage = parseInt(urlParams.get('page')) || 1;
    goToPage(currentPage + 1);
}

function goToPageLast() {
    // Получаем информацию о последней странице из текста на странице
    const paginationText = document.querySelector('.text-muted');
    if (paginationText) {
        const matches = paginationText.textContent.match(/из (\d+)|of (\d+)/);
        if (matches) {
            const total = parseInt(matches[1] || matches[2]);
            const urlParams = new URLSearchParams(window.location.search);
            const limit = parseInt(urlParams.get('limit')) || 25;
            const lastPage = Math.ceil(total / limit);
            goToPage(lastPage);
            return;
        }
    }
    // Fallback - получаем из URL или используем большое число
    goToPage(9999);
}

function refreshRooms() {
    window.location.reload();
}

function refreshRoomsList() {
    // Alias for compatibility with room_details.js
    window.location.reload();
}

function exportRooms() {
    const url = new URL('/rooms/export', window.location.origin);
    
    // Добавляем текущие фильтры к экспорту
    const currentUrl = new URL(window.location);
    for (const [key, value] of currentUrl.searchParams) {
        if (['search'].includes(key)) {
            url.searchParams.set(key, value);
        }
    }
    
    window.location.href = url.toString();
}

function viewRoom(roomId) {
    // Используем новое детальное модальное окно с табами
    showRoomDetails(roomId);
}

function editRoom(roomId) {
    // Переход на страницу редактирования
    window.location.href = '/rooms/' + roomId + '/edit';
}

function blockRoom(roomId) {
    if (confirm('Are you sure you want to block this room?')) {
        // Отправляем запрос на блокировку
        fetch('/api/rooms/block', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ room_id: roomId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Room blocked successfully', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error: ' + error.message, 'danger');
        });
    }
}



function deleteRoom(roomId) {
    currentRoomId = roomId;
    const modal = new bootstrap.Modal(document.getElementById('deleteRoomModal'));
    modal.show();
}



document.getElementById('confirmDeleteRoom').addEventListener('click', function() {
    const button = this;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
    button.disabled = true;
    
    fetch('/api/rooms/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            room_id: currentRoomId,
            message: 'Room deleted by administrator' 
        })
    })
    .then(response => {
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. You may need to log in again.');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('Комната успешно удалена', 'success');
            bootstrap.Modal.getInstance(document.getElementById('deleteRoomModal')).hide();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert('Ошибка удаления комнаты: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Ошибка при удалении комнаты: ' + error.message, 'danger');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';
    alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    
    const container = document.querySelector('.container-fluid');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
    } else {
        document.body.appendChild(alertDiv);
    }
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Загрузка состояний колонок при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadColumnStates();
});
</script>
<script src="{{ url_for('static', filename='js/room_details.js') }}"></script>
{% endblock %} 